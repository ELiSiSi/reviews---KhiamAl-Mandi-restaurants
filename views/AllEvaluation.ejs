<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ุฌููุน ุงูุชููููุงุช</title>
    <link rel="stylesheet" href="/AllEvaluation.css" />
  </head>
  <body>
    <!--start header-->
    <div class="header">
      <div class="header-container">
        <div class="logo"><img src="/image/logo.jpg" alt="ุฎูู ุงูููุฏู " /></div>
        <div class="name">
          <h1>ุฎูู ุงูููุฏู</h1>
        </div>
      </div>
    </div>
    <!--end header-->

    <div class="container">
      <h1>๐ ุชููููุงุช ุงูุนููุงุก</h1>

      <!-- โ ููุชุฑ ุงูุจุญุซ ุจุงูุชุงุฑูุฎ -->
      <div class="filter-section">
        <h3>๐ ููุชุฑ ุงูุชููููุงุช ุญุณุจ ุงูุชุงุฑูุฎ</h3>
        <div class="filter-inputs">
          <div class="filter-group">
            <label for="startDate">ูู ุชุงุฑูุฎ:</label>
            <input type="date" id="startDate" class="date-input" />
          </div>
          <div class="filter-group">
            <label for="endDate">ุฅูู ุชุงุฑูุฎ:</label>
            <input type="date" id="endDate" class="date-input" />
          </div>
          <button id="filterBtn" class="filter-btn">ุจุญุซ ๐</button>
          <button id="resetBtn" class="reset-btn">ุฅุนุงุฏุฉ ุชุนููู ๐</button>
        </div>
      </div>
<div class="delete-section">

      <form
        action="/Khiam-Al-Mandi-restaurants/show/api/deleteall?_method=DELETE"
        method="POST">
        <button type="submit" class="delete-all-btn">
          ๐๏ธ ุญุฐู ุฌููุน ุงูุชููููุงุช
        </button>
      </form>
</div>
      <div class="stats">
        <div class="stat-card">
          <h3>๐ ุฅุฌูุงูู ุงูุชููููุงุช</h3>
          <p class="stat-number" id="totalCount"><%= ratings.length %></p>
        </div>
        <div class="stat-card">
          <h3>โญ ูุชูุณุท ุงูุชููููุงุช</h3>
          <p class="stat-number" id="avgRating">
            <% if (ratings.length > 0) { const totalAvg = ratings.reduce((sum,
            r) => sum + (r.cashier + r.cleanliness + r.foodQuality + r.service)
            / 4, 0) / ratings.length; %> <%= totalAvg.toFixed(1) %>/10 <% } else
            { %> - <% } %>
          </p>
        </div>
      </div>

      <div class="table-wrapper">
        <table class="ratings-table">
          <thead>
            <tr>
              <th>#</th>
              <th>ุงูุงุณู</th>
              <th>ุฑูู ุงููุงุชู</th>
              <th>ุฑูู ุงูุทุงููุฉ</th>
              <th>ุงููุงุดูุฑ</th>
              <th>ุงููุธุงูุฉ</th>
              <th>ุฌูุฏุฉ ุงูุทุนุงู</th>
              <th>ุงูุฎุฏูุฉ</th>
              <th>ุงููุชูุณุท</th>
              <th>ููุงุญุธุงุช</th>
              <th>ุงูุชุงุฑูุฎ</th>
            </tr>
          </thead>
          <tbody id="ratingsTableBody">
            <% if (ratings.length === 0) { %>
            <tr>
              <td colspan="11" class="no-data">ูุง ุชูุฌุฏ ุชููููุงุช ุญุชู ุงูุขู</td>
            </tr>
            <% } else { %> <% ratings.forEach(function(rating, index) { const
            avg = ((rating.cashier + rating.cleanliness + rating.foodQuality +
            rating.service) / 4).toFixed(1); const ratingClass = avg >= 8 ?
            'excellent' : avg >= 6 ? 'good' : 'poor'; %>
            <tr class="<%= ratingClass %>" data-date="<%= rating.createdAt %>">
              <td><%= index + 1 %></td>
              <td class="name-cell"><strong><%= rating.name %></strong></td>
              <td class="phone-cell"><%= rating.phone || '-' %></td>
              <td><span class="badge"><%= rating.numGTables %></span></td>
              <td>
                <span class="rating-value"><%= rating.cashier %>/10</span>
              </td>
              <td>
                <span class="rating-value"><%= rating.cleanliness %>/10</span>
              </td>
              <td>
                <span class="rating-value"><%= rating.foodQuality %>/10</span>
              </td>
              <td>
                <span class="rating-value"><%= rating.service %>/10</span>
              </td>
              <td>
                <span class="average <%= ratingClass %>"><%= avg %></span>
              </td>
              <td class="notes-cell"><%= rating.notes || '-' %></td>
              <td class="date-cell">
                <%= new Date(rating.createdAt).toLocaleDateString('ar-EG') %>
              </td>
            </tr>
            <% }); %> <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const filterBtn = document.getElementById('filterBtn');
        const resetBtn = document.getElementById('resetBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const tableBody = document.getElementById('ratingsTableBody');
        const totalCount = document.getElementById('totalCount');
        const avgRating = document.getElementById('avgRating');

        // ุฌูุจ ูู ุงูุตููู
        const allRows = Array.from(tableBody.querySelectorAll('tr'));

        // ุฏุงูุฉ ุงูููุชุฑุฉ
        filterBtn.addEventListener('click', () => {
          const startDate = startDateInput.value
            ? new Date(startDateInput.value)
            : null;
          const endDate = endDateInput.value
            ? new Date(endDateInput.value)
            : null;

          if (endDate) {
            endDate.setHours(23, 59, 59, 999); // ููุงูุฉ ุงูููู
          }

          let visibleCount = 0;
          let totalAvg = 0;

          allRows.forEach((row) => {
            const rowDate = new Date(row.getAttribute('data-date'));

            let shouldShow = true;

            if (startDate && rowDate < startDate) {
              shouldShow = false;
            }

            if (endDate && rowDate > endDate) {
              shouldShow = false;
            }

            if (shouldShow) {
              row.style.display = '';
              visibleCount++;

              // ุญุณุงุจ ุงููุชูุณุท
              const avgCell = row.querySelector('.average');
              if (avgCell) {
                totalAvg += parseFloat(avgCell.textContent);
              }
            } else {
              row.style.display = 'none';
            }
          });

          // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
          totalCount.textContent = visibleCount;
          avgRating.textContent =
            visibleCount > 0
              ? (totalAvg / visibleCount).toFixed(1) + '/10'
              : '-';

          // ุฑุณุงูุฉ ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ
          if (visibleCount === 0) {
            tableBody.innerHTML =
              '<tr><td colspan="10" class="no-data">ูุง ุชูุฌุฏ ุชููููุงุช ูู ูุฐู ุงููุชุฑุฉ</td></tr>';
          }
        });

        // ุฅุนุงุฏุฉ ุชุนููู
        resetBtn.addEventListener('click', () => {
          startDateInput.value = '';
          endDateInput.value = '';

          allRows.forEach((row) => {
            row.style.display = '';
          });

          // ุฅุนุงุฏุฉ ุงูุฅุญุตุงุฆูุงุช ุงูุฃุตููุฉ
          totalCount.textContent = '<%= ratings.length %>';
          avgRating.textContent = `
                    <% if (ratings.length > 0) {
                        const totalAvg = ratings.reduce((sum, r) => sum + (r.cashier + r.cleanliness + r.foodQuality + r.service) / 4, 0) / ratings.length;
                    %>
                        <%= totalAvg.toFixed(1) %>/10
                    <% } else { %>
                        -
                    <% } %>
                `;
        });
      });
    </script>
  </body>
</html>
